collection.txt
import axios from "axios";
import { APIStatus, itemDataQuery, itemPriceQuery } from "./queries";
import { buildMemoryStorage, setupCache } from "axios-cache-interceptor";

const axiosTarkovDev = axios.create({
  baseURL: "https://api.tarkov.dev/graphql",
  timeout: 1000,
  headers: { "Content-Type": "application/json" },
});

setupCache(axiosTarkovDev, {
  location: "server",
  storage: buildMemoryStorage(),
  debug: ({ id, msg, data }) => {
    console.log(`[axios-cache] id=${id} msg=${msg}`, data);
  },
  ttl: 30 * 24 * 60 * 60 * 1000,
});

/**
 * itemDataQuery.query, itemPriceQuery.query,
 * @param query
 * @returns
 */
export async function fetchItemsData(query: string) {
  try {
    const response = await axiosTarkovDev.post("", {
      query: itemDataQuery.query,
      cache: {
        ttl: 5 * 60 * 1000,
      },
    });
    const data = response.data.data.items;
    return data;
  } catch (error) {
    throw error;
  }
}

export async function fetchAPIStatus() {
  const response = await axiosTarkovDev.post("", {
    query: APIStatus,
    cache: {
      ttl: 0,
    },
  });
  const data = JSON.stringify(response.data, null, 2);
  return data;
}



export async funcktion 
/*
// Test function to check connection to Tarkov Dev API
export async function testTarkovDevConnection() {
  return await fetchTarkovDev(testQuery);
}

// Factory fetch function for axiosTarkovDev instance
async function fetchTarkovDev(graphQLQuery: string) {
  const response = await axiosTarkovDev.post("", {
    query: graphQLQuery,
  });
  const data = JSON.stringify(response.data.data.items, null, 2);
  console.log("Successfully fetched data from Tarkov Dev API:");
  return data;
}
*/



















import type express from "express";
import { fetchAPIStatus, fetchItemsData } from "./fetch";
import {
  clearCollection,
  testConnection,
  updateItemsCron,
  updatePriceCron,
} from "./mongo.db";
import { itemDataQuery, itemPriceQuery } from "./queries";

const ObjectId = require("mongodb").ObjectId;
function getID(ObjectIdStr: string) {
  try {
    const objId = new ObjectId(ObjectIdStr);
    return objId;
  } catch (error) {
    throw new Error("Invalid ObjectId string");
  }
}

module.exports = function (app: express.Express) {
  app.get("/", (req, res) => {
    res.send("Welcome to the Tarkony Express Backend!");
  });
  app.get("/health", async (req, res) => {
    try {
      const result = await testConnection();
      console.log("\nDatabase connection OK");
      res.send(result);
    } catch (error) {
      console.log("\nDatabase connection FAIL", error);
      res.send(error);
    }
  });

  app.get("/APIHealth", async (req, res) => {
    try {
      const status = await fetchAPIStatus();
      console.log("\nAPI Status ok ");
      res.send(status);
    } catch (error) {
      console.log("\nAPI Error: ", error);
      res.send(error);
    }
  });

  app.get("/clearCollections", async (req, res) => {
    try {
      const resultPrice = await clearCollection("items_price");
      const resultData = await clearCollection("items_data");
      console.log("Collections cleared successfully.");
      res.send(
        "Collections cleared successfully." +
          JSON.stringify({ resultPrice, resultData })
      );
    } catch (error) {
      console.error("Error clearing collections:", error);
      res.status(500).send("CLEAR COLLECTIONS FAILED");
    }
  });

  app.get("/fetchItemsPrice", async (req, res) => {
    try {
      const data = await fetchItemsData(itemPriceQuery.query);
      console.log("\n Items price: ");
      res.send("ITEMS PRICE SUCCESSFUL: " + data);
    } catch (error) {
      console.error("Error items price:", error);
      res.status(500).send("ITEMS PRICE FAILED");
    }
  });

  app.get("/fetchItemsData", async (req, res) => {
    try {
      const data = await fetchItemsData(itemDataQuery.query);
      console.log("\n Items data:");
      res.send("ITEMS DATA SUCCESSFUL: " + data);
    } catch (error) {
      console.error("Error updating items data:", error);
      res.status(500).send("ITEMS DATA FAILED");
    }
  });

  app.get("/itemsPriceUpdate", async (req, res) => {
    try {
      const result = await updatePriceCron();
      console.log("Items price update successfully.");
      res.send("ITEMS PRICE SUCCESSFUL" + result);
    } catch (error) {
      console.error("Error updating items price:", error);
      res.status(500).send("ITEMS PRICE FAILED");
    }
  });

  app.get("/itemsDataUpdate", async (req, res) => {
    try {
      const result = await updateItemsCron();
      console.log("Items data update successfully.");
      res.send("ITEMS DATA SUCCESSFUL" + result);
    } catch (error) {
      console.error("Error updating items data:", error);
      res.status(500).send("ITEMS DATA FAILED");
    }
  });
};
//updatePriceDB;






//mongodb+srv://szabo93dani_db_user:P7ch1rySaWi7nsVt@cluster0.fva9gn7.mongodb.net/
//mongodb+srv://szabo93dani_db_user:<db_password>@cluster0.fva9gn7.mongodb.net/
//P7ch1rySaWi7nsVt

import { fetchItemsData, fetchItemsPrice } from "./fetch";

const { MongoClient, ServerApiVersion } = require("mongodb");
const uri =
  "mongodb+srv://szabo93dani_db_user:P7ch1rySaWi7nsVt@cluster0.fva9gn7.mongodb.net/?appName=Cluster0";

// Create a MongoClient with a MongoClientOptions object to set the Stable API version
const client = new MongoClient(uri, {
  serverApi: {
    version: ServerApiVersion.v1,
    strict: true,
    deprecationErrors: true,
  },
});
//run a test command to confirm a successful connection to MongoDB
export const testConnection = async () => {
  try {
    // Connect the client to the server	(optional starting in v4.7)
    await client.connect();
    await client.db("tarkony_express").command({ ping: 1 });
    console.log(
      "Pinged your deployment. You successfully connected to MongoDB!"
    );

    const collections = await client.db("tarkony_express").listCollections();
    console.log("Collections in tarkony_express database:");
    await collections.forEach((collection: any) =>
      console.log(` - ${collection.name}`)
    );
    // Send a ping to confirm a successful connection
  } finally {
    // Ensures that the client will close when you finish/error
    await client.close();
  }
};
testConnection();

async function getCollection(collectionName: string) {
  try {
    await client.connect();
    return await client.db("tarkony_express").collection(collectionName);
  } catch (error) {
    throw error;
  } finally {
    await client.close();
  }
}

/*
db func 
collection list
clear X collection 

Cél:

3rd lekérni adat, árak
feltölteni adat, árak
lekérni adat , árak
összefűzni adat + árak

*/

//Get One Document from MongoDB

export async function getOne(collectionName: string, sort = {} as object) {
  try {
    // Connect the client to the server	(optional starting in v4.7)
    const collection = await getCollection(collectionName);
    const data = await collection.findOne(sort);
    return data;
  } catch (error) {
    console.log(error);
  }
}

export async function getMore(collectionName: string, sort = {} as object) {
  try {
    const collection = await getCollection(collectionName);
    const result = await collection.find(sort).toArray();
    console.log(result);
    return result;
  } catch (error) {
    console.log(error);
  }
}

export async function updateManyDB(
  collectionName: string,
  data: Array<object>
) {
  try {
    const collection = await getCollection(collectionName);
    const result = await collection.updateMany({}, { $set: data });
    console.log(result);
    return result;
  } catch (error) {
    console.log(error);
  }
}

export async function updatePrices() {
  try {
    const newPrices = await fetchItemsPrice();
    const dbPrices = await getItemsPriceAll();
    console.log(
      { name: "newPrice", array: newPrices },
      { name: "dbPrices", array: dbPrices }
    );
  } catch (error) {
    error;
  }
}

export async function insertManyDB(
  collectionName: string,
  data: Array<object>
) {
  try {
    const collection = await getCollection(collectionName);
    const result = await collection.insertMany(data);
    console.log(result);
    return result;
  } catch (error) {
    console.log(error);
  }
}
//timemstamp_db: new Date()

export async function updatePriceDB(data: object) {
  try {
    const result = await updateManyDB("items_price", {
      data,
      timestamp_db: new Date(),
    });
    return result;
  } catch (error) {
    console.log(error);
  }
}

export async function updatePriceCron() {
  try {
    const fetchedItemsPrice = await fetchItemsPrice();
    console.log(fetchedItemsPrice);
    const timestamp_db = new Date();
    const upData = fetchedItemsPrice.map((items) => {
      return { ...items, timestamp_db };
    });
    const updateResult = await insertManyDB("items_price", upData);
    console.log(updateResult);
    return updateResult;
  } catch (error) {
    console.log(error);
  }
}
export async function updateDB(data: object) {
  try {
    const result = await updateManyDB("items_data", {
      data,
    });
    return result;
  } catch (error) {
    console.log(error);
  }
}
export async function updateItemsCron() {
  try {
    const fetchedItemsData = await fetchItemsData();
    console.log(fetchedItemsData);
    const updateResult = await insertManyDB("items_data", fetchedItemsData);
    console.log(updateResult);
    return updateResult;
  } catch (error) {
    console.log(error);
  }
}

//database data drop
export async function clearCollection(collectionName: string) {
  try {
    const collection = await getCollection(collectionName);
    const result = await collection.deleteMany({});
    console.log(result);
    return result;
  } catch (error) {
    console.log(error);
  }
}

export async function getItems() {
  try {
    const items_data_db = await getArrayDB("items_data", {});
    const items_price_db = await getArrayDB("items_price", {});
    return { items_data_db, items_price_db };
  } catch (error) {
    console.log(error);
  }
}

export async function getItemByID(id: string) {
  try {
    const item_data_db = await getOneDB("items_data", { id });
    const item_price_db = await getOneDB("items_price", { id });
    return { item_data_db, item_price_db };
  } catch (error) {
    console.log(error);
  }
}

export async function getCategories() {
  try {
    const categories = await getArrayDB("categories", {});
    return categories;
  } catch (error) {
    console.log(error);
  }
}

export async function getItemsPriceAll() {
  return await getMore("items_price", {});
}
export async function getItemsDataAll() {
  return await getMore("items_data", {});
}
